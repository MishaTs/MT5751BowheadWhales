---
title: "Panic in the Disko Bay: Distance Sampling for Identifying Bowhead Whales"
date: "`r format(Sys.Date(), format='%d %B %Y')`"
fontsize: 11pt
urlcolor: blue
output: 
  bookdown::pdf_document2:
    toc: false
    number_sections: false
papersize: a4
header-includes:
  - \usepackage{float}
  - \usepackage{sectsty}
  - \usepackage{paralist}
  - \usepackage{fancyhdr}
  - \usepackage{dcolumn}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE)
library(statsecol)
library(ggplot2)
library(dplyr)
library(Distance)
data(bowhead_LT)
load("dfModels.RData")

```

\subsectionfont{\raggedright}
\subsubsectionfont{\raggedright}

\pagenumbering{gobble}

\begin{centering}

\Large
{\bf Project 1: Distance Sampling}

\vspace{5cm}

```{r uni_logo, echo=F, out.width="50%"}
knitr::include_graphics("01-standard-vertical-black-text.png")

```

{\bf School of Mathematics and Statistics}

\vspace{1 cm}

\normalsize
in partial fulfilment of the requirements for \\
MT5751: Estimating Animal Abundance and Biodiversity \\

\end{centering}

\newpage

# Abstract

## Introduction
In this report, we aim to use distance sampling methods to estimate the abundance of Bowhead whales in Disko Bay. As the data show some observer avoidance, we also wish to explore different approaches used to deal with this issue. 

## Methods
Visual aerial surveys were conducted along 41 systematically placed east-west along the West Greenland coast, with a combined length of 4,445km. There were two observation platforms which each recorded the declination angle using inclinometers and the times of the first sighting and when the whale passed abeam, which were used to calculate the perpendicular and forward distances respectively. Both observers also recorded group size, and if there were any differences in size or declination between the two observers the mean of the two values was taken. The Beaufort sea state was recorded for each survey. The distances were left-truncated to 100m as the view was obscured close to the transect line(Rekdal et al. 2015). In total there were 58 valid whale observations. 

```{r Initial-histogram, echo = F, fig.cap="Histogram of bowhead whale detection distances, coloured by size of detected group", fig.height=3}
ggplot(data = bowhead_LT) + 
  geom_histogram(aes(x = distance, fill = as.factor(size)), 
                 breaks = seq(0,2.4, length.out = 12)) +
  labs(x = "Distance truncated by 0.1 km",
       y = "Observed # individuals",
       title = "Raw bowhead whale observations",
       subtitle = "Using 12 bins and minor left-truncated distances",
       fill = "Group size") + 
  theme_bw()
```
An initial plot of the detection distances suggests there could be some line avoidance, as more whales were detected further away from the plane than on the transect, even after the left-truncation. This could violate the assumption in distance sampling that animals are distributed independently with respect to the transect, or the assumption that all animals on the line are detected, depending on whether the whales are hiding or moving away in response to the plane (Buckland et al, 2015). Equally, this could just be stochastic variation as there is only a difference of 4 observations between the 0-0.2 bin and the 0.4-0.6 bin. 
We considered 3 approaches to deal with this problem. Firstly, treating the difference in detection as random variation and fitting detection functions as normal. This preserves all the observations but will result in overestimating the detection probability (and therefore underestimating abundance) if detection is not certain on the line. Another option is to bin the distances into 0-0.6km, 0.6-0.9km, …, 2.1-2.4km categories so that there are more observations in the first group than the others. This assumes the whales moved away from the observers, so those that would have been detected on the transect were instead seen up to 0.6km away. This method deals well with the potentially violated assumptions, but in grouping the data we lose a lot of information. 
```{r binned-histogram, echo = F, fig.cap = "Histogram of bowhead whale detection distances using custom bins, coloured by size of detected group", fig.height=3}
histBreaks2 <- c(0, 0.6, 0.9, 1.2, 1.5, 1.8, 2.1, max(bowhead_LT$distance, 
                                                      na.rm = TRUE))
ggplot(data = bowhead_LT) + 
  geom_histogram(aes(x = distance, fill = as.factor(size)), breaks = histBreaks2) +
  labs(x = "Distance truncated by 0.1 km",
       y = "Observerd # Individuals",
       title = "Binned bowhead whale observations",
       subtitle = "Using 7 custom bins with minor left-truncated distances",
       fill = "Group size") + 
  theme_bw()
```
The final option we considered is to left-truncate the distances up to the peak in detections at 0.64km. This method ensures we have the monotonic decline in detections with increasing distance, but again loses a lot of information and assumes that detection is certain 0.64km away from the plane. The monotonic decrease in detection allowed complex models with multiple covariates and adjustment terms to be fitted successfully, which didn’t happen for the other methods. However, given the small sample size these models likely suffer from over-fitting. 
```{r truncatedHistogram, fig.cap = "Histogram of truncated distances, coloured by size of group detected", fig.height=3}
bowhead_LT_Trunc = bowhead_LT %>% filter(distance >= 0.64) %>%
  mutate(distance = distance - 0.64)
ggplot(data = bowhead_LT_Trunc) + 
  geom_histogram(aes(x = distance, fill = as.factor(size)),
                 bins = 14) +
  labs(x = "Distance left-truncated by 0.74 km",
       y = "Observerd # Individuals",
       title = "Filtered bowhead whale observations",
       subtitle = "Using 14 bins with substantially left-truncated distances",
       fill = "Group size") + 
  theme_bw()
```
We used the Distance package to fit models using a maximum likelihood approach. For each data set (unedited, binned and truncated) we fitted half normal and hazard rate detection functions with all combinations of adjustment terms (cos, Hermite and polynomial) and covariates (group size and Beaufort sea state). We used AIC to compare between models fitted to the same data set. 
 
## Results

```{r chunkName1, echo = FALSE}
table <- data.frame(
	Model = c("Base HN + size", "Base HN", "Binned HN + size", "Binned HN", "Truncated HR + size", "Truncated HN", "Truncated HN + size"),
	Estimate = c(212.07, 228.82, 212.84, 229.54, 1803.36, 519.51, 608.75),
	SE = c(65.62, 71.45, 66.14, 72.22, 1346.22, 90.74, 154.26),
	LowerCI = c(112.13, 122.00, 112.32, 121.94, 461.56, 363.25, 356.93),
	UpperCI = c(401.06, 429.14, 403.31, 432.07, 7045.88, 743.00, 1038.20),
	AIC = c(86.03, 86.32, 197.58, 197.91, 27.20, 28.43, 28.73)
)

knitr::kable(table, caption = "Model Summary Table")
```

```{r chunkName2, echo = FALSE}
table2 <- data.frame(
	Model = c("Base HN + size", "Binned HN + size", "Truncated HR + size", "Truncated HN + size"),
	CoefficientofSize = c(6.16, 5.64, -1.53, -0.51),
	SE = c(5046.40, 305.31, 0.60, 0.26),
	SignificanceofSize = c("Not Significant", "Not Significant", "Significant", "Significant at 0.1 level")
)

knitr::kable(table2, caption = "Significance of 'Size' covariate")
```

Given raw data set the best model selected by AIC was half-normal detection function with size covariate and no adjustments. The model estimates whale abundance as 212 with confidence interval between 112.13 and 401.06. However, covariate included is not statistically significant, therefore, model without covariate gives similar estimate of whale abundance (229) with confidence interval between 112.13 and 401.06.

```{r rawDataModels, echo = F, results = FALSE, fig.cap="Detection functions using raw data"}
par(mfrow = c(2,2))
plot(baseRawHN, which=2, pl.col = adjustcolor("steelblue",0.5),border=NULL, lwd = 2, 
     breaks = histBreaks2,
     ylab = "Detection probability (g(x))", xlab = "Distance", las=1,
     main = "Base half-normal model")
# interesting that the covariate model assumes perfect detection of large-sized groups
# this is a quirk of the limited data --> only Region 2 has any within-group variation in size
plot(sizeRawHN, which=2, pl.col = adjustcolor("steelblue",0.5),border=NULL, lwd = 2, 
     breaks = histBreaks2,
     ylab = "Detection probability (g(x))", xlab = "Distance", las=1,
     main = "Half-normal model with covariates")
# both models have solid GOF but the covariate model is slightly better from visual QQ inspection
# get rid of ks = TRUE for  improvements
gof_ds(baseRawHN, main="Base Observed vs. Expected CDF")#, ks = TRUE)
gof_ds(sizeRawHN, main="Covariate Observed vs. Expected CDF")#, ks = TRUE)
```

When using binning, the best model selected by AIC is half-normal with no adjustments and size covariate. Similar to model using raw data, it gives estimate of abundance of 213 and confidence interval between 112.32 and 403.31. Covariate is not statistically significant. 

```{r rawDataModels2, echo = F, results = FALSE, fig.cap="Detection functions using binned data"}
par(mfrow = c(1,2))
plot(baseBinHN, which=2, pl.col = adjustcolor("steelblue",0.5),border=NULL, lwd = 2, 
     ylab = "Detection probability (g(x))", xlab = "Distance", las=1,
     main = "Base half-normal model")
# interesting that the covariate model assumes perfect detection of large-sized groups
# this is a quirk of the limited data --> only Region 2 has any within-group variation in size
plot(sizeBinHN, which=2, pl.col = adjustcolor("steelblue",0.5),border=NULL, lwd = 2, 
     ylab = "Detection probability (g(x))", xlab = "Distance", las=1,
     main = "Half-normal model with covariates")
```

However, preferred model chosen using truncated data is quite different. The best model is hazard rate with size covariate, which gives an estimate of 1803 whales with confidence interval between 461.56 and 7045.88. It is worth noting, that size covariate is significant here. However, given huge standard error, there’s a lot of uncertainty, therefore, it is likely that the model largely overestimates. It is then followed by half normal model with no covariates and half normal model with size covariate.

```{r rawDataModels3, echo = F, results = FALSE, fig.cap="Detection functions using truncated data"}
par(mfrow = c(2,3))
plot(baseTruncHN, which=2, pl.col = adjustcolor("steelblue",0.5),border=NULL, lwd = 2, 
     #breaks = histBreaks2,
     ylab = "Detection probability (g(x))", xlab = "Distance", las=1,
     main = "Base half-normal model")
# interesting that the covariate model assumes perfect detection of large-sized groups
# this is a quirk of the limited data --> only Region 2 has any within-group variation in size
plot(sizeTruncHN, which=2, pl.col = adjustcolor("steelblue",0.5),border=NULL, lwd = 2, 
     #breaks = histBreaks2,
     ylab = "Detection probability (g(x))", xlab = "Distance", las=1,
     main = "Half-normal model with covariates")
plot(sizeTruncHR, which=2, pl.col = adjustcolor("steelblue",0.5),border=NULL, lwd = 2, 
     #breaks = histBreaks2,
     ylab = "Detection probability (g(x))", xlab = "Distance", las=1,
     main = "Hazard rate model with covariates")
# both models have solid GOF but the covariate model is slightly better from visual QQ inspection
# get rid of ks = TRUE for  improvements
gof_ds(baseTruncHN, main="Base Half-Normal Observed vs. Expected CDF")#, ks = TRUE)
gof_ds(sizeTruncHN, main="Covariate Half-Normal Observed vs. Expected CDF")#, ks = TRUE)
gof_ds(sizeTruncHR, main="Covariate Hazard Rate Observed vs. Expected CDF")#, ks = TRUE)
```

Even though detection functions using truncated data has lowest AIC, it overestimates whale abundance. The reason might be limited to sample size and extrapolation based on the area we have no data about. Therefore, it might be best to use half normal detection function with size as a covariate to get the best estimate of whale abundance.


## Discussion

Given that whale count was conducted from the aircraft, there are several assumptions that might be violated. Since the area under the aircraft is not visible to surveyors, it creates a blind strip and, therefore, we cannot assume that objects on the transect line are detected with certainty. To account for this, passive monitoring such as cameras to check for the animals on the transect line could be used. Moreover, assumption that objects are detected at their initial locations is violated as well. Due to avoidance response, as whales notice observers, they might feel threat and are more likely to run away or hide which results in less observations within close distance. Since whales are never stationery, we are likely underestimating the true whale population size due to imperfect detection. To address this availability bias, hidden Markov model could be used (Borchers et al, 2013). HMM copes with a small data by fitting a more restrictive model, which incorporates information on how the plane moves. 
Violation of these assumptions bias our estimates of whale abundance – models will underestimate the real number of whales; therefore, truncation of data is needed. However, truncation reduces survey area by 30% and since data is quite unbalanced and sample size is small, it is not a great approximation of how whale abundance would look like in real life and any variation seen in estimates is due to stochasticity.

\newpage
# Code Appendix

\newpage
# References  